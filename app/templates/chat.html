<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>UK Contract Law AI ‚Äì Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body>
  <div class="nav-shell">
    <div class="nav">
      <div class="nav-left">
        <div class="nav-logo">UK</div>
        <div class="nav-title">Contract Law AI</div>
      </div>
      <div class="nav-links">
        <a href="{{ url_for('home') }}">Home</a>
        <a href="{{ url_for('chat') }}" class="active">Chat</a>
        <a href="{{ url_for('about') }}">About</a>
      </div>
      <div class="nav-pill">Model: uk-lawyer</div>
    </div>
  </div>

  <main class="page">
    <div class="panel-grid">
      <!-- Left: chat -->
      <section class="panel">
        <div class="panel-header">
          <div class="panel-title">Chat</div>
          <span class="small">IRAC ¬∑ Goods/Services/Digital</span>
        </div>

        <div id="chat-window" class="chat-window">
          <div class="message">
            <div class="avatar assistant">AI</div>
            <div class="bubble assistant">
              <div class="label">Assistant</div>
              <p>
                Ask me about contracts, refunds, unfair terms, and UK consumer rights.
                I can use your local PDF statutes and respond using the IRAC structure.
              </p>
            </div>
          </div>

          <div class="message">
            <div class="avatar user">U</div>
            <div class="bubble user">
              <div class="label">You</div>
              <p>
                My laptop arrived damaged and the retailer is refusing a refund. What
                are my rights under the Consumer Rights Act 2015?
              </p>
            </div>
          </div>
        </div>

        <div class="chat-footer">
          <div class="question-row">
            <div class="input-wrapper">
              <textarea
                id="question-input"
                rows="1"
                placeholder="Describe your contract or problem in detail..."
              ></textarea>
            </div>
            <button id="send-btn" class="btn-primary">
              <span>Ask AI</span><span>‚Üµ</span>
            </button>
          </div>

          <div class="chat-meta">
            <div class="meta-group">
              <div class="chip">
                <span>Matter type</span>
                <select id="matter-type">
                  <option value="auto">Auto detect</option>
                  <option value="goods">Goods</option>
                  <option value="services">Services</option>
                  <option value="digital">Digital content</option>
                </select>
              </div>
              <label class="chip chip-ghost">
                <input id="irac-toggle" type="checkbox" checked style="accent-color:#22c55e;" />
                <span>IRAC reasoning</span>
              </label>
            </div>
            <span class="small">Ctrl + Enter to send</span>
          </div>
        </div>
      </section>

      <!-- Right: PDFs + model info -->
      <section class="panel">
        <div class="sidebar-section">
          <div class="sidebar-header">
            <span>üìÇ Reference PDFs</span>
            <span class="small">Folder: <code>legal_docs/</code></span>
          </div>
          <input id="file-input" type="file" multiple accept=".pdf" />
          <p class="small">
            The backend should actually read PDFs from your
            <code>legal_docs/</code> folder. This upload box is just UI.
          </p>
          <ul id="file-list" class="sidebar-list">
            <li>
              <span>Consumer_Rights_Act_2015.pdf</span>
              <span class="badge-soft"><span>‚úÖ</span><span>Indexed</span></span>
            </li>
            <li>
              <span>Tesco_v_USDAW_2024.pdf</span>
              <span class="badge-soft"><span>‚öñÔ∏è</span><span>Case law</span></span>
            </li>
          </ul>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-header">
            <span>üß† Model status</span>
            <span class="small">Ollama</span>
          </div>
          <ul class="sidebar-list">
            <li>
              <span>Base model</span>
              <span><code>UK_Law_Real_Final.gguf</code></span>
            </li>
            <li>
              <span>Embeddings</span>
              <span><code>nomic-embed-text</code></span>
            </li>
            <li>
              <span>Ollama create</span>
              <span><code>ollama create uk-lawyer -f Modelfile</code></span>
            </li>
          </ul>
          <p class="small" style="margin-top:4px;">
            The HTML here is just the front-end. Wire it to your
            <code>streamlit</code> or API endpoint where the real model runs.
          </p>
        </div>
      </section>
    </div>
  </main>

  <script>
    const chatWindow = document.getElementById("chat-window");
    const questionInput = document.getElementById("question-input");
    const sendBtn = document.getElementById("send-btn");
    const matterType = document.getElementById("matter-type");
    const iracToggle = document.getElementById("irac-toggle");
    const fileInput = document.getElementById("file-input");
    const fileList = document.getElementById("file-list");

    function appendMessage(role, text, irac = false) {
      const msg = document.createElement("div");
      msg.className = "message";

      const avatar = document.createElement("div");
      avatar.className = "avatar " + (role === "user" ? "user" : "assistant");
      avatar.textContent = role === "user" ? "U" : "AI";

      const bubble = document.createElement("div");
      bubble.className = "bubble " + (role === "user" ? "user" : "assistant");

      if (role === "assistant" && irac) {
        const l = document.createElement("div");
        l.className = "irac-label";
        l.textContent = "IRAC Outline";
        bubble.appendChild(l);
      } else {
        const l = document.createElement("div");
        l.className = "label";
        l.textContent = role === "user" ? "You" : "Assistant";
        bubble.appendChild(l);
      }

      const p = document.createElement("p");
      p.innerHTML = text.replace(/\n/g, "<br>");
      bubble.appendChild(p);

      msg.appendChild(avatar);
      msg.appendChild(bubble);
      chatWindow.appendChild(msg);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function handleSend() {
      const q = questionInput.value.trim();
      if (!q) return;

      appendMessage("user", q);
      questionInput.value = "";
      questionInput.style.height = "auto";
      sendBtn.disabled = true;

      const mt = matterType.value;
      const irac = iracToggle.checked;

      // TODO: replace this with your real backend call
      setTimeout(() => {
        let label =
          mt === "goods" ? "Goods" :
          mt === "services" ? "Services" :
          mt === "digital" ? "Digital content" :
          "Auto-detected";

        const ans = irac
          ? "<strong>Issue:</strong> I‚Äôll identify the key legal question.\n\n" +
            "<strong>Rule:</strong> I‚Äôll pull relevant UK contract/consumer rules (e.g. CRA 2015).\n\n" +
            "<strong>Application:</strong> I‚Äôll apply those rules to your facts and any loaded PDFs.\n\n" +
            "<strong>Conclusion:</strong> I‚Äôll summarise your likely rights and options.\n\n" +
            "<em>Matter type:</em> " + label + " ¬∑ IRAC enabled."
          : "I‚Äôll analyse your problem using UK contract law and any loaded PDFs, then summarise your rights.\n\n" +
            "<em>Matter type:</em> " + label + ".";

        appendMessage("assistant", ans, irac);
        sendBtn.disabled = false;
      }, 600);
    }

    sendBtn.addEventListener("click", handleSend);

    questionInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        handleSend();
      }
    });

    questionInput.addEventListener("input", () => {
      questionInput.style.height = "auto";
      questionInput.style.height = questionInput.scrollHeight + "px";
    });

    fileInput.addEventListener("change", () => {
      const files = Array.from(fileInput.files || []);
      fileList.innerHTML = "";
      files.forEach((f) => {
        const li = document.createElement("li");
        const name = document.createElement("span");
        name.textContent = f.name;
        const badge = document.createElement("span");
        badge.className = "badge-soft";
        badge.innerHTML = "<span>üìö</span><span>Pending index</span>";
        li.appendChild(name);
        li.appendChild(badge);
        fileList.appendChild(li);
      });
    });
  </script>
</body>
</html>
